<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sauveyre: KeePass database viewer</title>
    
    <!-- msal.min.js can be used in the place of msal.js; included msal.js to make debug easy -->
    <script type="text/javascript" src="https://alcdn.msauth.net/lib/1.3.1/js/msal.js" integrity="sha384-YjtcEEqiYcRGh2K/ehq07C6Bk9jKrKoMgdFy9YGfTxtrmzV3GyNi0DDgwhmcCNrE" crossorigin="anonymous"></script>

    <!-- msal.js with a fallback to backup CDN -->
    <script type="text/javascript">
      if(typeof Msal === 'undefined')document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/lib/1.3.1/js/msal.js' type='text/javascript' %3E%3C/script%3E"));
    </script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" 
                    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div id="app" class="container-fluid"></div>
</body>
<script type="text/javascript" src="js/lib/kdbxweb.min.js"></script>
<script type="text/javascript" src="js/lib/reef.min.js"></script>
<script type="text/javascript" src="js/application.js"></script>

<script type="text/javascript">

    window.addEventListener('load', async () => {

        var application = new Application();

        var helper = {
            copyPassword: (input) => {
                var originalValue = undefined;
                if (input.type === 'password') {
                    originalValue = input.value;
                    var decryptedPassword = kdbx.decryptPwd(originalValue);                    
                    input.value = decryptedPassword;
                    input.type = 'text';
                }

                input.select();
                input.setSelectionRange(0, 99999); /*For mobile devices*/
                document.execCommand("copy");

                // Wait 0.5 seconds then swap back
                if (originalValue) {
                    timer = window.setTimeout(() => {
                        input.value = originalValue;
                        input.type = "password";
                    }, 500);
                }
            },

            moveSelectionTo: (increment, defaultIfNoSelection) => {
                var currentSelection = document.querySelector('li.itemselected');
                var currentIndex = 0;
                
                if (currentSelection !== null) {
                    currentIndex = currentSelection.getAttribute('data-index')*1;
                }
                else {
                    // No selection
                    if (defaultIfNoSelection !== null)
                        currentIndex = defaultIfNoSelection;
                    else return; // Nothing to do
                }

                var futurSelection = document.querySelector(`li.treeEntry[data-index='${currentIndex + increment}']`);
                if (futurSelection) {
                    var futurSelectionId = futurSelection.getAttribute('data-id')*1;
                    application.select(futurSelectionId);                    
                }
            }
        }
        

        // Register event receivers
        document.addEventListener('click', async (event) => {

            if (event.target.id == 'signIn') {
                await authentication.init();
                var result = await authentication.signIn();
                if (result && result.success) {
                    var isAllowed = await authentication.isAllowed();
                    if (isAllowed && isAllowed.isAllowed) {
                        application.app.data = {
                            isSignedIn: true,
                            userName: authentication.userName()
                        }
                        application.app.attach(application.pwd);

                        // Give focus to text field
                        window.setTimeout(() => {
                            document.getElementById('dbpassword').focus();
                        }, 500);
                    }
                }
            }

            if (event.target.id == 'signOut') {
                await authentication.signOut();
            }

            if (event.target.id == 'loadDB') {
                // Get password before disposing the element
                var dbpass = document.getElementById('dbpassword').value;
                //app.detach does not seem to work => open a ticket
                application.app.attached.splice(0);
                application.app.render();
                application.content.data.isLoading = true;
                // Get token
                var token = await authentication.getToken();
                if (token) {
                    var data = await kdbx.load(token, dbpass);
                    if (data) {
                        application.content.data = {
                            isLoading: false,
                        };

                        application.tree.data = {
                            rootGroup: data
                        };

                        application.content.attach(application.entryPanel);
                        application.tree.attach(application.searchEntries);

                        // Give focus to search
                        window.setTimeout(() => {
                            document.getElementById('searchKeyword').focus();
                        }, 500);
                    }
                    else {
                        // Could not log DB
                        application.content.data.isLoading = false;
                        application.pwd.data = {
                            error: "Could not open database. Check JS console for information."
                        }
                    }
                }
                else {
                    // Could not log DB
                    application.content.data.isLoading = false;
                    application.pwd.data = {
                        error: "Could not open database. Check JS console for information."
                    }
                }
            }

            if (event.target.classList.contains('copy-value')) {
                var input = document.getElementById(event.target.getAttribute('data-for'));
                helper.copyPassword(input);
            }

            // for the tree
            if (event.target.classList.contains('caret')) {
                event.target.parentElement.querySelector('.nested').classList.toggle('active');
                event.target.classList.toggle('caret-down');
            }

            if (event.target.classList.contains('treeEntry')) {
                var selectedId = event.target.getAttribute('data-id')*1;
                application.select(selectedId);
                // Go up the page
                scroll(0,0);
            }

        }, false);

        document.addEventListener('input', (event) => {

            if (event.target.id == 'searchKeyword') {
                var query = event.target.value;

                const filter = (tree, value) => {
                    for (const entry of tree.entries) {
                        if (entry.title.toLowerCase().includes(value.toLowerCase())) {
                            entry.hidden = false;
                        }
                        else {
                            entry.hidden = true;
                        }
                    }                  

                    for (const child of tree.children) {
                        const res = filter(child, value);
                    }
                };

                // Clone tree
                var treeCopy = Reef.clone(application.tree.data);
                // Filter values
                filter(treeCopy.rootGroup, query);
                // Copy back to Reef to update UI
                application.tree.data = treeCopy;
            }

        }, false);
        
        document.addEventListener('mousedown', (event) => {

            if (event.target.classList.contains('view-value')) {
                var input = document.getElementById(event.target.getAttribute('data-for'));
                var entryuuid = input.value;
                var decryptedPassword = kdbx.decryptPwd(entryuuid);
                
                input.value = decryptedPassword;
                input.type = 'text';

                // Wait for mouse up or leave to hide back the value
                const release = (event) => {
                    input.value = entryuuid;
                    input.type = "password";
                }
                event.target.addEventListener("mouseleave", release, false);
                event.target.addEventListener("mouseup", release, false);
            }

        }, false);

        document.addEventListener('keydown', (event) => {
            
            // submit DB password
            if (event.target.id === 'dbpassword' && event.keyCode === 13) {
                document.getElementById('loadDB').click();
            }

            // Allow navigation with keys up/down in the tree, regardless the focused control
            if (event.keyCode === 40) {
                // Key down
                helper.moveSelectionTo(+1, 0);
                event.preventDefault()
            }

            if (event.keyCode === 38) {
                // Key up
                helper.moveSelectionTo(-1, null);
                event.preventDefault()
            }

            // ESC to reset search and focus search field
            if (event.keyCode === 27) {
                var input = document.getElementById('searchKeyword');
                input.value = '';
                // Trigger input to refresh the ui
                input.dispatchEvent(new Event('input', {
                    bubbles: true,
                    cancelable: true,
                }));
                input.focus();
                event.preventDefault();
            }

            // Shortcut to copy password, regardless the focus only if an entry is selected
            if (event.ctrlKey && event.keyCode === 67) {
                var input = document.getElementById('entryPassword');
                helper.copyPassword(input);
                event.preventDefault();
            }

        }, false);

        application.app.render();

    });

</script>
</html>